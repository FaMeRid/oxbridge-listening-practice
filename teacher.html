<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - IELTS Reports</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --primary: #a81011;
      --primary-dark: #870d0e;
      --light: #f8f8f8;
      --dark: #222;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #f39c12;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--light);
      color: #333;
      min-height: 100vh;
      font-size: 16px;
    }

    .header-panel {
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo {
      height: 50px;
      cursor: pointer;
    }

    .header-center {
      flex: 1;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .logout-btn {
      padding: 10px 20px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #ffecec;
    }

    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 15px;
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 28px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-6px);
    }

    .stat-card h3 {
      color: var(--primary);
      margin: 0 0 12px;
      font-size: 16px;
    }

    .stat-card p {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-bottom: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      min-width: 600px;
    }

    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 13px;
    }

    tr:hover {
      background: #fff8e1;
      cursor: pointer;
    }

    .band-high { color: var(--success); font-weight: bold; }
    .band-medium { color: var(--warning); font-weight: bold; }
    .band-low { color: var(--danger); font-weight: bold; }

    #detailsModal, #clearConfirmModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content, .confirm-modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 95%;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 32px;
      cursor: pointer;
      color: #aaa;
    }

    .close-btn:hover { color: #333; }

    .answers-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .answers-table th, .answers-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    .answers-table th {
      background: var(--primary);
      color: white;
    }

    .correct { background: #e6f4ea !important; }
    .wrong { background: #fdecea !important; }

    #loginOverlay {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--primary) 0%, #ffffff 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    #loginBox {
      background: white;
      padding: 30px 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    #loginBox img {
      width: 120px;
      margin-bottom: 20px;
    }

    #loginBox h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 22px;
    }

    .input-group {
      display: flex;
      align-items: center;
      margin: 12px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .input-group span {
      background: #f8f8f8;
      padding: 12px 15px;
      font-size: 20px;
      color: #777;
    }

    .input-group input {
      flex: 1;
      padding: 12px;
      border: none;
      font-size: 16px;
    }

    #loginBtn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }

    #loginBtn:hover { background: var(--primary-dark); }

    #errorMsg { color: var(--danger); margin-top: 15px; font-size: 15px; }

    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .confirm-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .cancel-btn { background: #6c757d; color: white; }
    .delete-btn { background: var(--danger); color: white; }

    .confirm-btn:hover { opacity: 0.9; transform: translateY(-2px); }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è */
    @media (max-width: 768px) {
      body { font-size: 15px; }
      .header-panel { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
      .header-center { font-size: 20px; flex: 1 1 100%; text-align: center; }
      .logo { height: 40px; }
      .logout-btn { padding: 8px 16px; font-size: 14px; }
      .main-content { padding: 0 15px; margin: 20px auto; }
      h1 { font-size: 24px; }
      .stats { grid-template-columns: 1fr; gap: 15px; }
      .stat-card { padding: 15px; }
      .stat-card p { font-size: 24px; }
      .table-wrapper { overflow-x: auto; }
      table { font-size: 14px; min-width: 600px; }
      th, td { padding: 12px 10px; }
      .modal-content, .confirm-modal-content { padding: 20px; width: 95%; }
      .modal-content h2 { font-size: 22px; }
      .confirm-buttons { flex-direction: column; gap: 10px; }
      .confirm-btn { width: 100%; }
    }

    @media (max-width: 480px) {
      h1 { font-size: 20px; }
      .stat-card p { font-size: 22px; }
      table { font-size: 13px; min-width: 500px; }
      th, td { padding: 10px 8px; }
    }
  </style>
</head>
<body>

<div id="loginOverlay">
  <div id="loginBox">
    <img src="assets/logo2.png" alt="Oxbridge Logo">
    <h3>Teacher Login</h3>
    <div class="input-group">
      <span>üë§</span>
      <input type="text" id="login" placeholder="Login">
    </div>
    <div class="input-group">
      <span>üîí</span>
      <input type="password" id="password" placeholder="Password">
    </div>
    <button id="loginBtn" onclick="checkLogin()">Login</button>
    <div id="errorMsg"></div>
  </div>
</div>

<div class="header-panel" id="dashboardHeader" style="display:none;">
  <img id="logo" src="assets/logo.png" alt="Oxbridge Logo" class="logo">
  <div class="header-center">
    Teacher Dashboard
  </div>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="main-content" id="dashboard" style="display:none;">
  <div class="stats">
    <div class="stat-card">
      <h3>Students</h3>
      <p id="studentCount">0</p>
    </div>
    <div class="stat-card">
      <h3>Avg Band</h3>
      <p id="avgBand">0.0</p>
    </div>
    <div class="stat-card">
      <h3>Total Reports</h3>
      <p id="totalReports">0</p>
    </div>
  </div>

  <h1>All Student Results</h1>
  <div class="table-wrapper">
    <table id="reportsTable">
      <thead>
        <tr>
          <th>Student</th>
          <th>Total Score</th>
          <th>Band</th>
          <th>Last Report Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reportsBody"></tbody>
    </table>
  </div>

  <div style="text-align:center; margin:40px 0;">
    <button onclick="clearAllReports()" style="padding:14px 40px; background:var(--danger); color:white; border:none; border-radius:50px; font-size:17px; cursor:pointer;">
      Clear All Reports
    </button>
  </div>
</div>

<!-- Details Modal -->
<div id="detailsModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeDetails()">√ó</span>
    <h2 id="modalTitle">Student Report Details</h2>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Clear Confirmation Modal -->
<div id="clearConfirmModal">
  <div class="confirm-modal-content">
    <span class="close-btn" onclick="document.getElementById('clearConfirmModal').style.display='none'">√ó</span>
    <h2 style="color:var(--danger);">Clear All Reports?</h2>
    <p style="font-size:17px; margin:20px 0 30px; color:#444;">
      This action will permanently delete <strong>all</strong> student results from the cloud.<br>Are you sure?
    </p>
    <div class="confirm-buttons">
      <button class="confirm-btn cancel-btn" onclick="document.getElementById('clearConfirmModal').style.display='none'">Cancel</button>
      <button class="confirm-btn delete-btn" id="confirmClearBtn">Yes, Clear Everything</button>
    </div>
  </div>
</div>

<script>
// ================== Firebase ==================
const firebaseConfig = {
  apiKey: "AIzaSyC8o2F60E8Pi_TfEDA_z6EeokG-gECUXjg",
  authDomain: "oxbridge-listening-practice.firebaseapp.com",
  projectId: "oxbridge-listening-practice",
  storageBucket: "oxbridge-listening-practice.firebasestorage.app",
  messagingSenderId: "32964456597",
  appId: "1:32964456597:web:3a315700117ff92a6a2b9c",
  measurementId: "G-HBCHQ49MWS"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
// ================== /Firebase ==================

function checkLogin() {
  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();

  const savedPass = localStorage.getItem("teacherPass");

  if (login === "Shohruh" && (password === "asdfghjkl;'" || savedPass === password)) {
    if (!savedPass) localStorage.setItem("teacherPass", password);

    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("dashboardHeader").style.display = "flex";
    loadReports();
  } else {
    document.getElementById("errorMsg").innerText = "Invalid login or password";
  }
}

function logout() {
  if (confirm("Do you want to log out?")) {
    document.getElementById("loginOverlay").style.display = "flex";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("dashboardHeader").style.display = "none";
    document.getElementById("login").value = "";
    document.getElementById("password").value = "";
    document.getElementById("errorMsg").innerText = "";
  }
}

function loadReports() {
  const tbody = document.getElementById("reportsBody");
  tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</td></tr>';

  db.collection("reports")
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      tbody.innerHTML = "";

      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</td></tr>';
        updateStats(0, 0, 0);
        return;
      }

      const grouped = {};
      snapshot.forEach(doc => {
        const r = doc.data();
        if (!grouped[r.student]) {
          grouped[r.student] = { correct: 0, total: 0, date: r.date, parts: [] };
        }
        grouped[r.student].correct += r.correct;
        grouped[r.student].total += r.total;
        if (r.date > grouped[r.student].date) grouped[r.student].date = r.date;
        grouped[r.student].parts.push(r.part);
      });

      let totalStudents = Object.keys(grouped).length;
      let totalBandSum = 0;

      Object.keys(grouped).forEach(student => {
        const g = grouped[student];
        const band = Math.round((g.correct / g.total) * 9 * 2) / 2;
        totalBandSum += band;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${student}</td>
          <td>${g.correct} / ${g.total}</td>
          <td class="${band >= 7 ? 'band-high' : band >= 5 ? 'band-medium' : 'band-low'}">${band}</td>
          <td>${new Date(g.date).toLocaleString()}</td>
          <td><button onclick="showStudentDetails('${student}')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏</button></td>
        `;
        tbody.appendChild(row);
      });

      updateStats(totalStudents, totalBandSum / totalStudents || 0);
    }, error => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Firestore:", error);
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    });
}

function updateStats(students, avgBand) {
  document.getElementById("studentCount").innerText = students;
  document.getElementById("avgBand").innerText = avgBand.toFixed(1);
  document.getElementById("totalReports").innerText = students * 4; // assuming 4 parts per student
}

function showStudentDetails(student) {
  db.collection("reports")
    .where("student", "==", student)
    .orderBy("timestamp", "asc")
    .get()
    .then(snapshot => {
      if (snapshot.empty) {
        alert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞");
        return;
      }

      const modal = document.getElementById("detailsModal");
      const title = document.getElementById("modalTitle");
      const content = document.getElementById("modalContent");

      title.innerText = `${student} - –ü–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç`;

      let html = `<p><strong>–û–±—â–∏–π –±–∞–ª–ª:</strong> –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>`;
      html += `<p><strong>–û–±—â–∏–π Band:</strong> –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</p>`;

      let totalCorrect = 0;
      let totalQuestions = 0;

      snapshot.forEach(doc => {
        const report = doc.data();
        totalCorrect += report.correct;
        totalQuestions += report.total;

        html += `<h3>${report.part} - ${report.correct}/${report.total} (Band ${report.band})</h3>`;
        html += `<table class="answers-table">
          <tr><th>–í–æ–ø—Ä–æ—Å</th><th>–û—Ç–≤–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞</th><th>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π</th><th>–°—Ç–∞—Ç—É—Å</th></tr>`;

        Object.keys(report.answers).forEach(q => {
          const ans = report.answers[q];
          let user = ans.user || "‚Äî";
          let correct = Array.isArray(ans.correct) ? ans.correct.join(", ") : ans.correct || "‚Äî";
          let status = "‚Äî";
          let rowClass = "";

          if (user !== "‚Äî") {
            if (Array.isArray(ans.correct)) {
              const userArr = user.split(",").map(a => a.trim().toLowerCase());
              const correctArr = ans.correct.map(c => c.toLowerCase());
              const isCorrect = correctArr.length === userArr.length && correctArr.every(c => userArr.includes(c));
              status = isCorrect ? "Correct" : "Wrong";
              rowClass = isCorrect ? "correct" : "wrong";
            } else {
              const isCorrect = user.trim().toLowerCase() === ans.correct.toLowerCase();
              status = isCorrect ? "Correct" : "Wrong";
              rowClass = isCorrect ? "correct" : "wrong";
            }
          }

          html += `
            <tr class="${rowClass}">
              <td>${q}</td>
              <td>${user}</td>
              <td>${correct}</td>
              <td>${status}</td>
            </tr>
          `;
        });

        html += `</table><hr style="margin:20px 0;">`;
      });

      html = html.replace("–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...", `${totalCorrect} / ${totalQuestions}`);
      html = html.replace("–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...", Math.round((totalCorrect / totalQuestions) * 9 * 2) / 2);

      content.innerHTML = html;
      modal.style.display = "flex";
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π:", error);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞");
    });
}

function closeDetails() {
  document.getElementById("detailsModal").style.display = "none";
}

function clearAllReports() {
  document.getElementById("clearConfirmModal").style.display = "flex";
}

document.getElementById("confirmClearBtn").addEventListener("click", () => {
  if (confirm("–¢—ã —É–≤–µ—Ä–µ–Ω? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ –æ–±–ª–∞–∫–∞!")) {
    db.collection("reports").get().then(snapshot => {
      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));
      batch.commit().then(() => {
        alert("–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã");
        document.getElementById("clearConfirmModal").style.display = "none";
        loadReports();
      }).catch(error => {
        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
      });
    });
  }
});

window.onload = function() {
  const savedPass = localStorage.getItem("teacherPass");
  if (savedPass) {
    document.getElementById("login").value = "Shohruh";
    document.getElementById("password").value = savedPass;
    checkLogin();
  }
};
</script>

</body>
</html>