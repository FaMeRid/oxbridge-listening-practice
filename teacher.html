<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - IELTS Reports</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script src="common.js"></script>

  <style>
    :root {
      --primary: #a81011;
      --primary-dark: #870d0e;
      --light: #f8f8f8;
      --dark: #222;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #f39c12;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--light);
      color: #333;
      min-height: 100vh;
      font-size: 16px;
    }

    .header-panel {
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo {
      height: 50px;
      cursor: pointer;
    }

    .header-center {
      flex: 1;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .logout-btn {
      padding: 10px 20px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover { background: #ffecec; }

    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 15px;
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 28px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover { transform: translateY(-6px); }

    .stat-card h3 {
      color: var(--primary);
      margin: 0 0 12px;
      font-size: 16px;
    }

    .stat-card p {
      font-size: 28px;
      font-weight: bold;
      margin: 0;
    }

    .table-wrapper {
      overflow-x: auto;
      margin-bottom: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      min-width: 600px;
    }

    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 13px;
    }

    tr:hover {
      background: #fff8e1;
      cursor: pointer;
    }

    .band-high { color: var(--success); font-weight: bold; }
    .band-medium { color: var(--warning); font-weight: bold; }
    .band-low { color: var(--danger); font-weight: bold; }

    #detailsModal, #clearConfirmModal, #loginOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content, .confirm-modal-content {
      background: white;
      padding: 35px;
      border-radius: 12px;
      max-width: 95%;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 32px;
      cursor: pointer;
      color: #aaa;
    }

    .close-btn:hover { color: #333; }

    .answers-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .answers-table th, .answers-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    .answers-table th {
      background: var(--primary);
      color: white;
    }

    .correct { background: #e6f4ea !important; color: #155724; }
    .wrong { background: #fdecea !important; color: #721c24; }

    #loginOverlay {
      background: linear-gradient(135deg, var(--primary) 0%, #ffffff 100%);
    }

    #loginBox {
      background: white;
      padding: 30px 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    #loginBox img {
      width: 120px;
      margin-bottom: 20px;
    }

    #loginBox h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 22px;
    }

    .input-group {
      display: flex;
      align-items: center;
      margin: 12px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .input-group span {
      background: #f8f8f8;
      padding: 12px 15px;
      font-size: 20px;
      color: #777;
    }

    .input-group input {
      flex: 1;
      padding: 12px;
      border: none;
      font-size: 16px;
    }

    #loginBtn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }

    #loginBtn:hover { background: var(--primary-dark); }

    #errorMsg { color: var(--danger); margin-top: 15px; font-size: 15px; }

    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .confirm-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .cancel-btn { background: #6c757d; color: white; }
    .delete-btn { background: var(--danger); color: white; }

    .confirm-btn:hover { opacity: 0.9; transform: translateY(-2px); }

    .details-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(168,16,17,0.2);
    }

    .details-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168,16,17,0.3);
    }

    .details-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(168,16,17,0.2);
    }

    @media only screen and (max-width: 768px) {
      .header-panel {
        flex-direction: column;
        align-items: center;
        padding: 10px 15px;
        gap: 8px;
      }
      .header-center {
        font-size: 20px;
        text-align: center;
        flex: 1 1 100%;
      }
      .logo { height: 40px; }
      .logout-btn { padding: 8px 14px; font-size: 14px; }
      .main-content { padding: 0 12px; margin-top: 20px; }
      h1 { font-size: 24px; text-align: center; margin-bottom: 20px; }
      .stats { grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
      .stat-card { padding: 15px; }
      .stat-card h3 { font-size: 14px; }
      .stat-card p { font-size: 22px; }
      .table-wrapper { overflow-x: auto; }
      table { font-size: 14px; min-width: 580px; }
      th, td { padding: 10px; }
      th { font-size: 12px; }
      .details-btn { padding: 8px 16px; font-size: 14px; width: 100%; }
      .modal-content, .confirm-modal-content { padding: 20px; width: 90%; }
      .modal-content h2, .confirm-modal-content h2 { font-size: 20px; }
      .answers-table th, .answers-table td { font-size: 12px; padding: 8px; }
    }
  </style>
</head>
<body>

<div id="loginOverlay">
  <div id="loginBox">
    <img src="assets/logo.png" alt="Oxbridge Logo">
    <h3>Teacher Login</h3>
    <div class="input-group">
      <span><i class="fas fa-user"></i></span>
      <input type="text" id="login" placeholder="Email" autocomplete="off">
    </div>
    <div class="input-group">
      <span><i class="fas fa-lock"></i></span>
      <input type="password" id="password" placeholder="Password" autocomplete="off">
    </div>
    <button id="loginBtn" onclick="checkLogin()">Login</button>
    <div id="errorMsg"></div>
  </div>
</div>

<div id="dashboard" style="display:none;">
  <div class="header-panel" id="dashboardHeader" style="display:none;">
    <img id="logo" src="assets/logo.png" alt="Oxbridge Logo" class="logo">
    <div class="header-center">Teacher Dashboard - IELTS Reports</div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main-content">
    <h1>Student Reports</h1>

    <div class="stats">
      <div class="stat-card">
        <h3>Total Students</h3>
        <p id="studentCount">0</p>
      </div>
      <div class="stat-card">
        <h3>Average Band</h3>
        <p id="avgBand">0.0</p>
      </div>
      <div class="stat-card">
        <h3>Total Reports</h3>
        <p id="totalReports">0</p>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Score (correct/total)</th>
            <th>Band</th>
            <th>Latest Test</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportsBody">
          <tr><td colspan="5" style="text-align:center;padding:30px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <button style="display:block;margin:0 auto 40px;padding:14px 40px;background:var(--danger);color:white;border:none;border-radius:50px;font-size:18px;cursor:pointer;" onclick="clearAllReports()">
      Clear All Reports
    </button>
  </div>
</div>

<!-- Student Details Modal -->
<div id="detailsModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeDetails()">×</span>
    <h2 id="modalTitle">Student Details</h2>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Clear Confirmation Modal -->
<div id="clearConfirmModal">
  <div class="confirm-modal-content">
    <h2>Confirmation</h2>
    <p>Are you sure you want to delete ALL student results?<br>This action cannot be undone!</p>
    <div class="confirm-buttons">
      <button class="confirm-btn cancel-btn" onclick="document.getElementById('clearConfirmModal').style.display='none'">Cancel</button>
      <button class="confirm-btn delete-btn" id="confirmClearBtn">Delete All</button>
    </div>
  </div>
</div>

<script>
// ✅ FIXED - Group by student only, sum ALL parts
function loadReports() {
  const tbody = document.getElementById("reportsBody");
  tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">Loading...</td></tr>';

  if (typeof db === "undefined" || !db) {
    tbody.innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;padding:30px;">Firebase not connected.</td></tr>';
    return;
  }

  db.collection("reports")
    .orderBy("timestamp", "desc")
    .onSnapshot(snapshot => {
      tbody.innerHTML = "";

      if (snapshot.empty) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:30px;">No results yet</td></tr>';
        updateStats(0, 0, 0);
        return;
      }

      // ✅ Group by student ONLY - get ALL reports per student
      const allStudentReports = {};
      
      snapshot.forEach(doc => {
        const r = doc.data();
        const student = r.student;
        
        if (!allStudentReports[student]) {
          allStudentReports[student] = [];
        }
        
        allStudentReports[student].push({
          part: r.part,
          correct: r.correct || 0,
          total: r.total || 0,
          band: r.band || 0,
          timestamp: r.timestamp ? r.timestamp.toDate() : new Date(r.date || 0)
        });
      });

      // ✅ For each student, get LATEST of each part and sum ALL
      const studentSummary = {};
      
      Object.keys(allStudentReports).forEach(student => {
        const reports = allStudentReports[student];
        
        // Sort by timestamp descending
        reports.sort((a, b) => b.timestamp - a.timestamp);
        
        // Group by part name and keep only LATEST of each part
        const latestByPart = {};
        reports.forEach(report => {
          if (!latestByPart[report.part]) {
            latestByPart[report.part] = report;
          }
        });
        
        // Sum ALL parts (however many exist)
        let totalCorrect = 0;
        let totalQuestions = 0;
        let latestDate = new Date(0);
        
        Object.values(latestByPart).forEach(report => {
          totalCorrect += report.correct;
          totalQuestions += report.total;
          if (report.timestamp > latestDate) {
            latestDate = report.timestamp;
          }
        });
        
        studentSummary[student] = {
          correct: totalCorrect,
          total: totalQuestions,
          date: latestDate.toLocaleString("en-US"),
          partsCompleted: Object.keys(latestByPart).length
        };
      });

      let totalStudents = Object.keys(studentSummary).length;
      let totalBandSum = 0;
      let totalReports = totalStudents;

      Object.keys(studentSummary).forEach(student => {
        const g = studentSummary[student];
        const band = g.total > 0 ? Math.round((g.correct / g.total) * 9 * 2) / 2 : 0;
        totalBandSum += band;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${student}</td>
          <td>${g.correct} / ${g.total}</td>
          <td class="${band >= 7 ? 'band-high' : band >= 5 ? 'band-medium' : 'band-low'}">${band}</td>
          <td>${g.date}</td>
          <td><button class="details-btn" onclick="showStudentDetails('${student}')">View Details</button></td>
        `;
        tbody.appendChild(row);
      });

      updateStats(totalStudents, totalBandSum / totalStudents || 0, totalReports);
    }, error => {
      console.error("Error loading reports:", error);
      tbody.innerHTML = '<tr><td colspan="5" style="color:red;text-align:center;padding:30px;">Error loading data</td></tr>';
    });
}

function showStudentDetails(student) {
  if (typeof db === "undefined" || !db) {
    document.getElementById("modalContent").innerHTML = '<p style="color:red;">Firebase not connected</p>';
    document.getElementById("modalTitle").innerText = "Error";
    document.getElementById("detailsModal").style.display = "flex";
    return;
  }

  db.collection("reports")
    .where("student", "==", student)
    .orderBy("timestamp", "desc")
    .get()
    .then(snapshot => {
      const latest = {};
      snapshot.forEach(doc => {
        const r = doc.data();
        const key = r.part || 'unknown';

        let reportDate = new Date(0);
        if (r.timestamp && typeof r.timestamp.toDate === 'function') {
          reportDate = r.timestamp.toDate();
        } else if (r.date) {
          reportDate = new Date(r.date);
        }

        if (!latest[key] || reportDate > new Date(latest[key]?.date || 0)) {
          latest[key] = {
            ...r,
            date: reportDate,
            correct: r.correct || 0,
            total: r.total || 0,
            band: r.band || 0,
            answers: r.answers || {}
          };
        }
      });

      let totalCorrect = 0;
      let totalQuestions = 0;

      let html = `<h2>Student: ${student}</h2>`;

      const partOrder = ["Part 1", "Part 2", "Part 3", "Part 4"];

      if (Object.keys(latest).length === 0) {
        html += '<p style="color:orange;">No saved reports for this student</p>';
      } else {
        let hasAnyPart = false;

        partOrder.forEach(partName => {
          const report = latest[partName];
          if (report) {
            hasAnyPart = true;
            totalCorrect += report.correct;
            totalQuestions += report.total;

            html += `<h3>${partName} — ${report.correct} / ${report.total} (Band ${report.band})</h3>`;
            html += '<p>Date: ' + (report.date ? new Date(report.date).toLocaleString("en-US") : 'Unknown') + '</p>';

            html += '<table class="answers-table"><tr><th>Question</th><th>Student Answer</th><th>Correct Answer</th><th>Status</th></tr>';

            if (Object.keys(report.answers).length > 0) {
              const sortedKeys = Object.keys(report.answers).sort((a, b) => {
                const numA = parseInt(a.replace("q", ""), 10);
                const numB = parseInt(b.replace("q", ""), 10);
                return numA - numB;
              });

              sortedKeys.forEach(q => {
                const ans = report.answers[q];
                const user = ans.user || "—";
                const correct = Array.isArray(ans.correct) ? ans.correct.join(", ") : ans.correct || "—";
                let status = "—";
                let rowClass = "";

                if (user !== "—") {
                  if (Array.isArray(ans.correct)) {
                    const userArr = user.split(",").map(a => a.trim().toLowerCase());
                    const correctArr = ans.correct.map(c => c.toLowerCase());
                    const isCorrect = correctArr.length === userArr.length && correctArr.every(c => userArr.includes(c));
                    status = isCorrect ? "Correct" : "Wrong";
                    rowClass = isCorrect ? "correct" : "wrong";
                  } else {
                    const isCorrect = normalizeAnswer(user) === normalizeAnswer(ans.correct);
                    status = isCorrect ? "Correct" : "Wrong";
                    rowClass = isCorrect ? "correct" : "wrong";
                  }
                }

                html += `<tr class="${rowClass}"><td>${q}</td><td>${user}</td><td>${correct}</td><td>${status}</td></tr>`;
              });
            } else {
              html += '<tr><td colspan="4">No answers in this part</td></tr>';
            }

            html += '</table><hr style="margin:20px 0;">';
          }
        });

        if (!hasAnyPart) {
          html += '<p style="color:orange;">No reports for main parts (Part 1–4)</p>';
        }

        html = `<p><strong>Total Score:</strong> ${totalCorrect} / ${totalQuestions}</p>` +
               `<p><strong>Overall Band:</strong> ${Math.round((totalCorrect / totalQuestions || 0) * 9 * 2) / 2}</p><br>` +
               html;
      }

      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modalTitle").innerText = `Student: ${student}`;
      document.getElementById("detailsModal").style.display = "flex";
    })
    .catch(error => {
      console.error("Error getting details:", error);
      document.getElementById("modalContent").innerHTML = `<p style="color:red;">Error: ${error.message || 'Check internet or Firebase access'}</p>`;
      document.getElementById("modalTitle").innerText = "Error";
      document.getElementById("detailsModal").style.display = "flex";
    });
}

function normalizeAnswer(str) {
  if (!str) return "";
  return str.toLowerCase().trim().replace(/\s+/g, " ").replace(/[.,!?;:'"()]/g, "").replace(/\b(a|an|the)\b\s*/gi, "");
}

function updateStats(students, avgBand, totalReports) {
  document.getElementById("studentCount").innerText = students;
  document.getElementById("avgBand").innerText = avgBand.toFixed(1);
  document.getElementById("totalReports").innerText = totalReports;
}

function clearAllReports() {
  document.getElementById("clearConfirmModal").style.display = "flex";
}

document.getElementById("confirmClearBtn").addEventListener("click", () => {
  if (confirm("Are you sure? This will delete ALL student results!")) {
    if (typeof db === "undefined" || !db) {
      alert("Firebase not connected");
      return;
    }

    db.collection("reports").get().then(snapshot => {
      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));
      batch.commit().then(() => {
        alert("All results deleted");
        document.getElementById("clearConfirmModal").style.display = "none";
        loadReports();
      }).catch(error => {
        console.error("Delete error:", error);
        alert("Error deleting: " + error.message);
      });
    }).catch(error => {
      console.error("Error getting reports:", error);
      alert("Error: " + error.message);
    });
  }
});

function closeDetails() {
  document.getElementById("detailsModal").style.display = "none";
}

function signInTeacher(email, password) {
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(userCredential => {
      console.log("Teacher logged in:", userCredential.user.email);
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("dashboardHeader").style.display = "flex";
      loadReports();
    })
    .catch(error => {
      console.error("Login error:", error);
      document.getElementById("errorMsg").innerText = "Login error: " + error.message;
    });
}

function checkLogin() {
  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();
  const savedPass = localStorage.getItem("teacherPass");

  if (login === "sh.shoberdiev@gmail.com" && (password === "asdfghjkl;'" || savedPass === password)) {
    if (!savedPass) localStorage.setItem("teacherPass", password);
    signInTeacher(login, password);
  } else {
    document.getElementById("errorMsg").innerText = "Invalid email or password";
  }
}

function logout() {
  if (confirm("Logout from teacher account?")) {
    firebase.auth().signOut().then(() => {
      localStorage.removeItem("teacherPass");
      document.getElementById("loginOverlay").style.display = "flex";
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("dashboardHeader").style.display = "none";
      document.getElementById("login").value = "";
      document.getElementById("password").value = "";
      document.getElementById("errorMsg").innerText = "";
    });
  }
}

window.onload = function() {
  const savedPass = localStorage.getItem("teacherPass");
  if (savedPass && document.getElementById("login") && document.getElementById("password")) {
    document.getElementById("login").value = "sh.shoberdiev@gmail.com";
    document.getElementById("password").value = savedPass;
    checkLogin();
  }
};

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    console.log("Teacher already logged in:", user.email);
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("dashboardHeader").style.display = "flex";
    loadReports();
  } else {
    console.log("No logged in user");
    document.getElementById("loginOverlay").style.display = "flex";
  }
});
</script>
</body>
</html>