<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard - IELTS Reports</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <script src="common.js"></script>

  <style>
    :root {
      --primary: #a81011;
      --primary-dark: #870d0e;
      --light: #f8f8f8;
      --dark: #222;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #f39c12;
      --overlay: rgba(0,0,0,0.65);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--light);
      color: #333;
      min-height: 100vh;
      font-size: 16px;
    }

    .header-panel {
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo { height: 50px; cursor: pointer; }

    .header-center {
      flex: 1;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
    }

    .logout-btn {
      padding: 10px 20px;
      background: white;
      color: var(--primary);
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover { background: #ffecec; }

    .main-content {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 15px;
    }

    h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 30px;
      font-size: 28px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      text-align: center;
      transition: transform 0.3s;
    }

    .stat-card:hover { transform: translateY(-6px); }

    .stat-card h3 { color: var(--primary); margin: 0 0 12px; font-size: 16px; }

    .stat-card p { font-size: 28px; font-weight: bold; margin: 0; }

    .table-wrapper { overflow-x: auto; margin-bottom: 40px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
      min-width: 600px;
    }

    th, td {
      padding: 14px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }

    th {
      background: var(--primary);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 13px;
    }

    tr:hover { background: #fff8e1; cursor: pointer; }

    .band-high { color: var(--success); font-weight: bold; }
    .band-medium { color: var(--warning); font-weight: bold; }
    .band-low { color: var(--danger); font-weight: bold; }

    /* Modals & overlay */
    #detailsModal, #secureClearModal, #loginOverlay, #loadingOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--overlay);
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-content {
      background: white;
      padding: 35px;
      border-radius: 12px;
      max-width: 95%;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 32px;
      cursor: pointer;
      color: #aaa;
    }

    .close-btn:hover { color: #333; }

    .answers-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .answers-table th, .answers-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
      font-size: 14px;
    }

    .answers-table th { background: var(--primary); color: white; }

    .correct { background: #e6f4ea !important; color: #155724; }
    .wrong { background: #fdecea !important; color: #721c24; }

    #loginOverlay { background: linear-gradient(135deg, var(--primary) 0%, #ffffff 100%); }

    #loginBox {
      background: white;
      padding: 30px 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    #loginBox img { width: 120px; margin-bottom: 20px; }

    #loginBox h3 { color: var(--primary); margin-bottom: 20px; font-size: 22px; }

    .input-group {
      display: flex;
      align-items: center;
      margin: 12px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
    }

    .input-group span {
      background: #f8f8f8;
      padding: 12px 15px;
      font-size: 20px;
      color: #777;
    }

    .input-group input {
      flex: 1;
      padding: 12px;
      border: none;
      font-size: 16px;
    }

    #loginBtn {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 17px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }

    #loginBtn:hover { background: var(--primary-dark); }

    #errorMsg { color: var(--danger); margin-top: 15px; font-size: 15px; }

    .confirm-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      flex-wrap: wrap;
    }

    .confirm-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      min-width: 120px;
    }

    .cancel-btn { background: #6c757d; color: white; }
    .delete-btn { background: var(--danger); color: white; }

    .confirm-btn:hover { opacity: 0.9; transform: translateY(-2px); }

    .details-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(168,16,17,0.2);
    }

    .details-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(168,16,17,0.3);
    }

    /* Loading Spinner */
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255,255,255,0.3);
      border-top: 6px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      body { font-size: 15px; }
      .header-panel { padding: 10px 15px; flex-wrap: wrap; gap: 10px; }
      .header-center { font-size: 20px; flex: 1 1 100%; }
      .logo { height: 40px; }
      .logout-btn { padding: 8px 16px; font-size: 14px; }
      .main-content { padding: 0 15px; margin: 20px auto; }
      h1 { font-size: 24px; }
      .stats { grid-template-columns: 1fr; gap: 15px; }
      .details-btn { width: 100%; padding: 12px; font-size: 16px; }
    }
  </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay">
  <div class="spinner"></div>
</div>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div id="loginBox">
    <img src="assets/logo.png" alt="Oxbridge Logo">
    <h3>Teacher Login</h3>
    <div class="input-group">
      <span><i class="fas fa-user"></i></span>
      <input type="text" id="login" placeholder="Login (Shohruh)" autocomplete="off">
    </div>
    <div class="input-group">
      <span><i class="fas fa-lock"></i></span>
      <input type="password" id="password" placeholder="Password" autocomplete="off">
    </div>
    <button id="loginBtn" onclick="checkLogin()">Login</button>
    <div id="errorMsg"></div>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" style="display:none;">
  <div class="header-panel" id="dashboardHeader" style="display:none;">
    <img id="logo" src="assets/logo.png" alt="Oxbridge Logo" class="logo">
    <div class="header-center">Teacher Dashboard - IELTS Reports</div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main-content">
    <h1>Student Reports</h1>

    <div class="stats">
      <div class="stat-card">
        <h3>Number of Students</h3>
        <p id="studentCount">0</p>
      </div>
      <div class="stat-card">
        <h3>Average Band</h3>
        <p id="avgBand">0.0</p>
      </div>
      <div class="stat-card">
        <h3>Total Reports</h3>
        <p id="totalReports">0</p>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Student</th>
            <th>Score (correct/total)</th>
            <th>Band</th>
            <th>Last Test</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportsBody">
          <tr><td colspan="5" style="text-align:center;padding:30px;">Loading...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Clear All Reports Button -->
    <button id="clearAllBtn"
            style="display:block; margin:50px auto 60px; padding:16px 50px;
                   background:var(--danger); color:white; border:none;
                   border-radius:50px; font-size:18px; font-weight:bold;
                   cursor:pointer; box-shadow:0 6px 20px rgba(220,53,69,0.3);
                   transition:all 0.3s;">
      Clear All Reports
    </button>
  </div>
</div>

<!-- Student Details Modal -->
<div id="detailsModal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeDetails()">×</span>
    <h2 id="modalTitle">Student Details</h2>
    <div id="modalContent"></div>
  </div>
</div>

<!-- Secure Clear Confirmation Modal with Password -->
<div id="secureClearModal" style="display:none;">
  <div class="modal-content" style="max-width:420px; padding:35px;">
    <span class="close-btn" onclick="document.getElementById('secureClearModal').style.display='none'">×</span>
    <h2 style="color:var(--danger);">Clear All Reports?</h2>
    <p style="margin:20px 0; color:#444;">
      This action will <strong>permanently delete</strong> all student reports.<br>
      This cannot be undone.
    </p>
    
    <p style="font-weight:bold; margin-bottom:12px;">Enter security password:</p>
    <input type="password" id="clearPassword" placeholder="Security password" 
           style="width:100%; padding:12px; font-size:16px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;">
    
    <div id="clearError" style="color:var(--danger); font-weight:bold; min-height:24px; margin:10px 0; display:none;"></div>
    
    <div class="confirm-buttons">
      <button class="confirm-btn cancel-btn" 
              onclick="document.getElementById('secureClearModal').style.display='none'">Cancel</button>
      <button class="confirm-btn delete-btn" 
              onclick="confirmClearWithPassword()">Delete All</button>
    </div>
  </div>
</div>

<script>
// Security password
const CLEAR_PASSWORD = "oxbridge2026";

// Loading
function showLoading(show) {
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = show ? "flex" : "none";
}

// Teacher sign in
function signInTeacher(email, password) {
  firebase.auth().signInWithEmailAndPassword(email, password)
    .then(() => {
      document.getElementById("loginOverlay").style.display = "none";
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("dashboardHeader").style.display = "flex";
      loadReports();
    })
    .catch(error => {
      document.getElementById("errorMsg").innerText = "Login error: " + error.message;
    });
}

function checkLogin() {
  const login = document.getElementById("login").value.trim();
  const password = document.getElementById("password").value.trim();

  const savedPass = localStorage.getItem("teacherPass");

  if (login === "Shohruh" && (password === "asdfghjkl;'" || savedPass === password)) {
    if (!savedPass) localStorage.setItem("teacherPass", password);
    signInTeacher("sh.shoberdiev@gmail.com", password);
  } else {
    document.getElementById("errorMsg").innerText = "Invalid login or password";
  }
}

function logout() {
  firebase.auth().signOut().then(() => {
    localStorage.removeItem("teacherPass");
    document.getElementById("loginOverlay").style.display = "flex";
    document.getElementById("dashboard").style.display = "none";
    document.getElementById("dashboardHeader").style.display = "none";
    document.getElementById("login").value = "";
    document.getElementById("password").value = "";
    document.getElementById("errorMsg").innerText = "";
  });
}

// Confirm clear with password
function confirmClearWithPassword() {
  const input = document.getElementById("clearPassword").value.trim();
  const errorEl = document.getElementById("clearError");

  if (input === CLEAR_PASSWORD) {
    document.getElementById("secureClearModal").style.display = "none";
    showLoading(true);

    db.collection("reports").get()
      .then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      })
      .then(() => {
        alert("All reports have been successfully deleted");
        loadReports();
        showLoading(false);
      })
      .catch(err => {
        console.error("Clear error:", err);
        alert("Error deleting reports: " + err.message);
        showLoading(false);
      });
  } else {
    errorEl.textContent = "Incorrect password";
    errorEl.style.display = "block";
  }
}

// Open clear modal
document.getElementById("clearAllBtn").addEventListener("click", () => {
  document.getElementById("clearPassword").value = "";
  document.getElementById("clearError").style.display = "none";
  document.getElementById("secureClearModal").style.display = "flex";
});

// Paste here all your other functions: loadReports, showStudentDetails, normalizeAnswer, updateStats, closeDetails, etc.
// They remain the same as in your original file — just keep the English versions of alerts and texts inside them if needed.

window.onload = function() {
  const savedPass = localStorage.getItem("teacherPass");
  if (savedPass) {
    document.getElementById("login").value = "Shohruh";
    document.getElementById("password").value = savedPass;
    checkLogin();
  }
};

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    document.getElementById("loginOverlay").style.display = "none";
    document.getElementById("dashboard").style.display = "block";
    document.getElementById("dashboardHeader").style.display = "flex";
    loadReports();
  } else {
    document.getElementById("loginOverlay").style.display = "flex";
  }
});
</script>

</body>
</html>